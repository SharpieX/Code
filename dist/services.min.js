angular.module("stack.service",[]),angular.module("stack.service").factory("userService",["$q","$http","$stamplay","$rootScope",function(a,b,c,d){var e=!1;return d.login=function(){c.User.socialLogin("github")},d.logout=function(){c.User.logout()},{isLogged:function(){return e},getUserModel:function(){var b=a.defer();return c.User.currentUser().then(function(a){a.user.hasOwnProperty("_id")?(a.user.points=a.user.points||0,e=!0,b.resolve(a.user)):(e=!1,b.resolve(!1))})["catch"](function(a){b.reject(a)}),b.promise}}}]).factory("usersService",["$q","$stamplay",function(a,b){return{getUsers:function(){var c=a.defer();return b.User.get({}).then(function(a){c.resolve(a.data)})["catch"](function(a){c.reject(a)}),c.promise},getById:function(c){var d=a.defer();return b.User.get({_id:c}).then(function(a){d.resolve(a.data[0])})["catch"](function(a){d.reject(a)}),d.promise},searchUser:function(c){var d=a.defer();return b.User.get(c).then(function(a){d.resolve(a.data)})["catch"](function(a){d.reject(a)}),d.promise}}}]),angular.module("stack.service").factory("tagsService",["$q","$stamplay",function(a,b){return{getTags:function(c){var d=a.defer();return c=c||{},b.Object("tag").get(c).then(function(a){d.resolve(a.data)})["catch"](function(a){d.reject(a)}),d.promise},getById:function(c){var d=a.defer();return b.Object("tag").get({_id:c}).then(function(a){d.resolve(a.data[0])})["catch"](function(a){d.reject(a)}),d.promise},searchTag:function(c){var d=a.defer();return b.Object("tag").get(c).then(function(a){d.resolve(a.data)})["catch"](function(a){d.reject(a)}),d.promise}}}]),angular.module("stack.service").factory("questionsService",["$q","usersService","tagsService","answersService","$stamplay",function(a,b,c,d,e){function f(a){return a.actions.votes.users_upvote.length-a.actions.votes.users_downvote.length}var g=[],h={};return{getQuestions:function(b){var c=a.defer();return e.Object("question").get(b).then(function(a){h=a.pagination.total_elements;for(var b=a.data,d=0;d<b.length;d+=1)b[d].author=b[d].owner,g.push(b[d]);c.resolve({pagination:h,questions:g})}),c.promise},searchQuestion:function(b){var c=a.defer();return e.Object("question").get({_id:b,populate:!0,populate_owner:!0}).then(function(a){var b=a.data[0],d=_.pluck(b.answers,"_id");b.author=b.owner,e.Object("answer").get({where:JSON.stringify({_id:{$in:d}}),populate_owner:!0}).then(function(a){b.answers=a.data,c.resolve(b)})})["catch"](function(a){c.reject(a)}),c.promise},getById:function(b){var c=a.defer();return this.searchQuestion(b).then(function(a){c.resolve(a)}),c.promise},updateViews:function(a){var b=a.views||0;return b++,e.Object("question").patch(a._id,{views:b})},updateModel:function(a,b){var c={};return b.forEach(function(b){if("answers"!==b&&"owner"!==b&&"tags"!==b&&"author"!==b)c[b]=a[b];else{for(var d=[],e=0;e<a[b].length;e+=1)d.push(a[b][e]._id);c.answers=d}}),c._id=a._id,e.Object("question").patch(c._id,c)},voteUp:function(b){var c=a.defer(),d=b;return e.Object("question").upVote(b._id).then(function(a){d.actions=a.actions,c.resolve(f(d))})["catch"](function(a){c.reject(a)}),c.promise},voteDown:function(b){var c=a.defer(),d=b;return e.Object("question").downVote(b._id).then(function(a){d.actions=a.actions,c.resolve(f(d))})["catch"](function(a){c.reject(a)}),c.promise},commentQuestion:function(b,c){var d=a.defer(),f=b;return e.Object("question").comment(f._id,c).then(function(a){f.actions=a.actions,d.resolve(f)})["catch"](function(a){d.reject(a)}),d.promise},saveQuestion:function(b){var d=a.defer();return e.Object("question").save(b).then(function(a){var f=a.data;async.each(b.tags,function(a,b){c.getById(a).then(function(a){var c=c||0;a.count=c++,e.Object("tag").patch(a._id,a).then(function(){b()})["catch"](function(a){b(a)})})},function(a){a?d.reject(a):d.resolve(f)})}),d.promise},submitAnswer:function(a,b){var c=a.answers;return c.push(b),a.answers=c,this.updateModel(a,["answers"])}}}]),angular.module("stack.service").factory("answersService",["$q","usersService","$stamplay",function(a,b,c){function d(a){return a.actions.votes.users_upvote.length-a.actions.votes.users_downvote.length}return{createAnswer:function(b){var d=a.defer(),e={};return angular.forEach(b,function(a,b){e[b]=a}),c.Object("answer").save(e).then(function(a){d.resolve(a)})["catch"](function(a){d.reject(a)}),d.promise},updateModel:function(a,b){var d={};return b.forEach(function(b){d[b]=a[b]}),c.Object("answer").patch(a._id,d)},voteUp:function(b){var e=a.defer(),f=b;return c.Object("answer").upVote(f._id).then(function(a){f.actions=a.actions,e.resolve(d(f))})["catch"](function(a){e.reject(a)}),e.promise},voteDown:function(b){var e=a.defer(),f=b;return c.Object("answer").downVote(f._id).then(function(a){f.actions=a.actions,e.resolve(d(f))})["catch"](function(a){e.reject(a)}),e.promise},comment:function(b,d){var e=a.defer(),f=b;return c.Object("answer").comment(f._id,d).then(function(a){f.actions=a.actions,e.resolve()})["catch"](function(a){e.reject(a)}),e.promise},getById:function(d){var e=a.defer(),f=c.Cobject("answer").Model;return f.fetch(d).then(function(){return b.getById(f.get("author"))}).then(function(a){f.set("author",a),e.resolve(f)})["catch"](function(a){e.reject(a)}),e.promise}}}]);